name: Deploy Vivasam HTML

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via SSH (git pull on server)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: 159.65.226.33                 # <-- YOUR SERVER IP/Domain
          username: root                    # <-- YOUR LINUX USER
          password: ym4tA4SBFyCbW
          script: |
            cd /var/www/vivasam
            echo "machine github.com login exabitorg password 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" > ~/.netrc

            WEBROOT="/var/www/vivasam"                 # <-- Nginx root
            BRANCH="main"
            REPO="https://github.com/exabitorg/vivasam.git"   # <-- your repo HTTPS URL

            REPO_NAME="exabitorg/vivasam"
            ACTOR="${{ github.actor }}"
            COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
            COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"

            sudo mkdir -p "$WEBROOT"
            sudo chown -R "$USER":"$USER" "$WEBROOT"

            if [ ! -d "$WEBROOT/.git" ]; then
              echo "First-time setup: cloning into $WEBROOT"
              git clone --depth=1 --branch "$BRANCH" "$REPO" "$WEBROOT"
            fi

            cd "$WEBROOT"
            git config --global --add safe.directory "$WEBROOT"
            git fetch origin "$BRANCH"
            git reset --hard "origin/$BRANCH"

            # If your site files are in a subfolder (e.g., dist/), copy them up:
            # cp -a dist/. "$WEBROOT"/

            # Telegram notify
            if ls *.html >/dev/null 2>&1; then
              MSG=$'âœ… Build SUCCESS and deployed\nğŸ“¦ Repo: '"$REPO_NAME"$'\nğŸ‘¤ Pushed by: '"$ACTOR"$'\nğŸ“ Commit: '"$COMMIT_MESSAGE"$'\nğŸ”— '"$COMMIT_URL"
              curl -s -X POST "https://api.telegram.org/bot8001007521:AAHiFMtf-GippKEHqsaLTr81VtP7k1b-Kco/sendMessage" \
                -d chat_id=-1002513646170 \
                --data-urlencode "text=$MSG" \
                -d parse_mode=Markdown
            else
              MSG=$'âŒ Build FAILED â€” no .html found\nğŸ“¦ Repo: '"$REPO_NAME"$'\nğŸ‘¤ Pushed by: '"$ACTOR"$'\nğŸ“ Commit: '"$COMMIT_MESSAGE"$'\nğŸ”— '"$COMMIT_URL"
              curl -s -X POST "https://api.telegram.org/bot8001007521:AAHiFMtf-GippKEHqsaLTr81VtP7k1b-Kco/sendMessage" \
                -d chat_id=-1002513646170 \
                --data-urlencode "text=$MSG" \
                -d parse_mode=Markdown
              exit 1
            fi

            sudo nginx -t && sudo systemctl reload nginx
