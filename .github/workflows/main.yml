name: Deploy Vivasam HTML

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via SSH (git pull on server)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -euo pipefail

            WEBROOT="/var/www/vivasam"
            BRANCH="main"
            REPO="https://github.com/${{ github.repository }}.git"   # use HTTPS

            REPO_NAME="${{ github.repository }}"
            ACTOR="${{ github.actor }}"
            COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
            COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"

            sudo mkdir -p "$WEBROOT"
            sudo chown -R "$USER":"$USER" "$WEBROOT"

            if [ ! -d "$WEBROOT/.git" ]; then
              echo "First-time setup: cloning into $WEBROOT"
              git clone --depth=1 --branch "$BRANCH" "$REPO" "$WEBROOT"
            fi

            cd "$WEBROOT"
            git config --global --add safe.directory "$WEBROOT"
            git fetch origin "$BRANCH"
            git reset --hard "origin/$BRANCH"

            # If your site files are in a subfolder (e.g., dist/), copy them up:
            # cp -a dist/. "$WEBROOT"/

            # Deploy check + Telegram
            if ls *.html >/dev/null 2>&1; then
              MSG=$'âœ… Deploy SUCCESS and live\nğŸ“¦ Repo: '"$REPO_NAME"$'\nğŸ‘¤ Pushed by: '"$ACTOR"$'\nğŸ“ Commit: '"$COMMIT_MESSAGE"$'\nğŸ”— '"$COMMIT_URL"
              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
                -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
                --data-urlencode "text=$MSG"
            else
              MSG=$'âŒ Deploy FAILED â€” no .html found\nğŸ“¦ Repo: '"$REPO_NAME"$'\nğŸ‘¤ Pushed by: '"$ACTOR"$'\nğŸ“ Commit: '"$COMMIT_MESSAGE"$'\nğŸ”— '"$COMMIT_URL"
              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
                -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
                --data-urlencode "text=$MSG"
              exit 1
            fi

            sudo nginx -t && sudo systemctl reload nginx
